# Round 4: 実装優先度ティアリングと最終判定

**日時**: 2026-02-27T14:18:00+09:00
**前ラウンドからの焦点**: 32のGuardを実装優先度で分類し、実行可能なアクションプランに落とし込む

---

### 🔄 Round 4: Must / Should / Could ティアリング

**🏛️ Fault Architect**: 32のGuardを「DRGフェーズP1-P6のどこで実装するか」と「致命的エラーの防止に必要か」で分類する。

#### 🔴 Must（P1-P2で実装。怠ればシステム崩壊）

| Guard | 対策 | 実装フェーズ | 対象シナリオ |
|-------|------|------------|-------------|
| G1.1 | アトミック書き込み（tmp→rename） | P1 | S3, E5.5 |
| G1.2 | JSON.parse検証 | P1 | E1.1 |
| G1.3 | スキーマバリデーション | P1 | E1.2 |
| G1.7 | セッション開始時バックアップ | P1 | E1.7, E3.5 |
| G2.5 | MCP独立フォールバック | P2 | E2.5, S2 |
| G2.6 | **Canary Check** | P2 | **S1（最重要）** |
| G3.4/G8.1 | memory/ を.gitignore | P1 | E8.1 |
| G4.1 | /goにDRG読み込みハードコード | P5 | E4.1 |
| G8.2 | DRGにPII格納禁止（IDのみ） | P1 | E8.2, E8.3 |

**9件。P1-P2で全て実装する。**

#### 🟡 Should（P3-P5で実装。品質と安定性向上）

| Guard | 対策 | 実装フェーズ |
|-------|------|------------|
| G1.4 | エッジ整合性チェック | P2 |
| G1.6 | ファイルロック（flock） | P4 |
| G2.1 | 30秒タイムアウト | P2 |
| G2.3 | レート制限対応（backoff） | P2 |
| G2.4 | MCP応答スキーマ検証 | P3 |
| G3.1 | decisions.json TTL（90日） | P4 |
| G3.2 | 判断記録にコンテキスト条件を含める | P4 |
| G4.2 | last_synced差分チェック | P5 |
| G5.2 | イベントのタイムスタンプ順処理 | P6 |
| G5.3 | イベントIDによるdedup | P6 |
| G7.1 | DRG vs 実データの整合性サンプリング | P5 |
| G8.4 | pre-commitフックでPIIスキャン | P4 |

**12件。P3-P5で順次実装。**

#### 🟢 Could（P6以降。余裕があれば。なくても運用可能）

| Guard | 対策 |
|-------|------|
| G1.5 | 循環検出（DFS） |
| G2.2 | OAuth2失敗時のSlack通知 |
| G3.3 | patterns.jsonのconfidence_score減衰 |
| G4.3 | Canary Checkのプロトコル統合 |
| G4.4 | プロトコル60秒上限 |
| G5.1 | SECRETARY BUDDYのPID監視 |
| G5.4 | アトミック操作（G1.1で既にカバー） |
| G6.1-6.4 | 相関検出の精度改善 |
| G7.2-7.4 | 運用保護の細部 |
| G8.3 | L3推論の人間関係制限ルール |

**11件。** 

**🤔 Skeptic**: 優先度は妥当だ。1つだけ — **Mustに入っていないG1.8（git管理）** はMustにすべきでは？ `data_graph.json`がgit管理されなければ、バックアップが存在しないのと同義だ。

**🏛️ Fault Architect**: 同意。G1.8をMustに移動。合計Must = 10件。

**😈 Devil's Advocate**: 最後の問いを投げる。これだけ洗い出しても、**実装者が1つのGuardを入れ忘れた場合のセーフティネットは？** 答えは「テスト」しかない。**DRGのテスト戦略** も明示すべきだ。

**⚡ Chaos Engineer**: 最低限のテスト：

| テスト | 内容 |
|--------|------|
| T1 | DRG書き込み中にSIGKILL → アトミック性の検証 |
| T2 | 全MCP切断状態でのセッション開始 → フォールバック検証 |
| T3 | 不正なJSON / スキーマ違反データの読み込み → バリデーション検証 |
| T4 | 既知ページのCanary Check → 権限縮小検知の検証 |
| T5 | `data_graph.json` に顧客名を挿入 → PIIスキャンが検知するか |

---

### 🧭 Moderator Review

| 項目 | 内容 |
|------|------|
| 明確になったこと | Must 10件 / Should 12件 / Could 11件の優先度分類完了。テスト戦略T1-T5策定 |
| まだ残る懸念・論点 | なし — 全ペルソナの懸念が構造的に解決された |
| 次ラウンドの焦点 | なし |
| **判定** | `Conclude` |
| **判定根拠** | (1) 48エラーの独立・複合パターンが構造的に特定済み（MR-03条件クリア）、(2) 32 Guardの対処方針が3層防御で明示済み、(3) 実装優先度がMust/Should/Couldで明確、(4) テスト戦略で検証可能性を担保、(5) 信頼境界が明示されており、「何を信頼し何を疑うか」が構造化されている |
