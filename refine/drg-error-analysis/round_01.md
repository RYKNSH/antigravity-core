# Round 1: レイヤー別エラー分類 — 表面の地図を描く

**日時**: 2026-02-27T14:15:00+09:00
**前ラウンドからの焦点**: DRGアーキテクチャの6つの構成要素に対するエラーの網羅的カタログ化

---

### 🔄 Round 1: 構成要素ごとの障害モード

**🏛️ Fault Architect**: まず攻撃対象を構造化する。DRGアーキテクチャは6層で構成される。各層のエラーを分類する：

#### Layer 1: DRGファイル本体（`data_graph.json`）

| # | エラー | 深刻度 | 発生条件 |
|---|--------|--------|---------|
| E1.1 | JSONパースエラー（構文破損） | 🔴 致命 | 手動編集ミス、不完全な書き込み、ディスク障害 |
| E1.2 | スキーマ違反（必須フィールド欠損） | 🟡 中 | バージョンアップ時のマイグレーション漏れ |
| E1.3 | ノード参照の不整合（存在しないIDへのエッジ） | 🟡 中 | ノード削除後のエッジ残留（dangling reference） |
| E1.4 | 循環依存（A→B→C→A） | 🟡 中 | 関係性の誤入力 |
| E1.5 | ファイルロック競合（同時書き込み） | 🟡 中 | 複数プロセスからの更新（SECRETARY BUDDY + AI） |
| E1.6 | ファイルサイズ爆発 | 🟢 低 | L2ノードが数万件に肥大化 |
| E1.7 | ファイル消失（誤削除・.gitignore漏れ） | 🔴 致命 | ユーザー操作ミス、git cleanで巻き込まれる |
| E1.8 | エンコーディング破損（日本語ファイル名のUTF-8問題） | 🟡 中 | OS間のエンコーディング差異 |

#### Layer 2: MCP接続（MCPバス）

| # | エラー | 深刻度 | 発生条件 |
|---|--------|--------|---------|
| E2.1 | MCP接続タイムアウト | 🟡 中 | ネットワーク障害、API側の遅延 |
| E2.2 | MCP認証失敗（トークン期限切れ） | 🔴 致命 | OAuth2トークンのリフレッシュ失敗、APIキーのローテーション |
| E2.3 | MCP APIレート制限超過 | 🟡 中 | ブートストラップ時の大量リクエスト |
| E2.4 | MCP応答のスキーマ変更（Breaking Change） | 🔴 致命 | 外部サービスのAPI更新 |
| E2.5 | 単一MCP障害の波及（カスケード障害） | 🟡 中 | 1つのMCPタイムアウトが全体の処理をブロック |
| E2.6 | MCP未接続の検知漏れ（サイレント障害） | 🔴 致命 | MCP接続は成功するがデータが空/古い |
| E2.7 | Notion MCP未導入状態での誤動作 | 🟡 中 | P3（Notion MCP追加）前に他のフェーズを実行 |

#### Layer 3: memory/システム（永続記憶）

| # | エラー | 深刻度 | 発生条件 |
|---|--------|--------|---------|
| E3.1 | decisions.jsonの肥大化（100MB超） | 🟡 中 | TTL未実装 or TTL判定漏れ |
| E3.2 | 判断履歴の矛盾（同じ状況で過去に逆の判断記録） | 🟡 中 | コンテキスト依存の判断が抽象化されて保存された場合 |
| E3.3 | patterns.jsonの過学習（偏ったパターン蓄積） | 🟡 中 | 一時期の行動パターンが恒久ルールとして固定化 |
| E3.4 | contradictions.jsonが空のまま運用（失敗の記録がない） | 🟢 低 | 記録トリガーの設計漏れ |
| E3.5 | memory/ディレクトリごと消失 | 🔴 致命 | 外部SSD取り外し、ディスク障害 |

#### Layer 4: セッション開始プロトコル

| # | エラー | 深刻度 | 発生条件 |
|---|--------|--------|---------|
| E4.1 | DRG読み込みスキップ（プロトコル未実行） | 🔴 致命 | /goワークフロー更新の反映漏れ |
| E4.2 | 古いDRGを読み込む（キャッシュ問題） | 🟡 中 | 前セッションの更新が書き込み完了前にクラッシュ |
| E4.3 | NEXT_SESSION.mdとDRGの矛盾 | 🟡 中 | 手動でNEXT_SESSION.mdに書いた内容がDRGと不整合 |
| E4.4 | MCPヘルスチェックのfalse positive | 🟡 中 | MCPが接続はするがデータ取得に失敗する状態 |
| E4.5 | プロトコル実行時間の爆発（30秒以上） | 🟡 中 | DRG肥大化 + 全MCPの応答遅延の合算 |

#### Layer 5: 自動同期（イベント駆動）

| # | エラー | 深刻度 | 発生条件 |
|---|--------|--------|---------|
| E5.1 | Webhook受信失敗（SECRETARY BUDDY停止中） | 🟡 中 | プロセスクラッシュ、デプロイ中のダウンタイム |
| E5.2 | イベント順序逆転（後のイベントが先に処理される） | 🟡 中 | 非同期キュー処理の並行性 |
| E5.3 | 重複イベント（同じ変更が2回DRGに適用される） | 🟡 中 | Webhookのリトライ |
| E5.4 | 同期対象外のサービスでの変更見落とし | 🟡 中 | LINE/SNSなどMCP未対応チャネル |
| E5.5 | DRG更新中のクラッシュ（部分更新） | 🔴 致命 | 停電、OOMKill |
| E5.6 | 同期ラグによる判断ミス（DRGが5分前の状態） | 🟢 低 | リアルタイム性不要な設計だが、緊急時に問題 |

#### Layer 6: 相関検出（3層モデル）

| # | エラー | 深刻度 | 発生条件 |
|---|--------|--------|---------|
| E6.1 | False Positive（無関係なデータを相関と誤検出） | 🟡 中 | L1の名前一致が偶然マッチ（例:「日記」が複数プロジェクトに存在） |
| E6.2 | False Negative（明らかな相関を見逃す） | 🟡 中 | 異なる命名規則（英語/日本語混在） |
| E6.3 | AI推論（L3）の幻覚（存在しない相関を捏造） | 🔴 致命 | LLMのハルシネーション |
| E6.4 | 相関スコアの劣化（時間経過で無意味になった相関が残る） | 🟢 低 | TTL/衰減メカニズムの未実装 |

**🤔 Skeptic**: 39個のエラーが出た。だが、これは **各エラーが独立に発生する前提** だ。実際には複合エラー（E2.1 + E5.1 = ネットワーク障害時にDRGが古いまま判断を進める）の方が遥かに危険。独立エラーの列挙は始まりに過ぎない。

**😈 Devil's Advocate**: そして最も恐ろしいのは **ここに書かれていないエラー** だ。「Unknown Unknowns」。例えば「macOSのアップデートでKeychainのAPIが変わり、全MCP認証が同時に死ぬ」。これは上のどのカテゴリにも入らない。

**⚡ Chaos Engineer**: 複合エラーは Round 2 で扱うべきだ。まず Round 1 の成果として、39個の独立エラーは構造的に分類されている。

---

### 🧭 Moderator Review

| 項目 | 内容 |
|------|------|
| 明確になったこと | 6層39エラーの独立障害カタログが完成。致命度分類（🔴8件、🟡25件、🟢6件）|
| まだ残る懸念・論点 | 複合エラー（カスケード障害）、Unknown Unknowns、対処方針未策定 |
| 次ラウンドの焦点 | 複合エラーシナリオ（「何が壊れたらどこまで波及するか」）|
| **判定** | `Continue` |
| **判定根拠** | 独立エラーのみ。複合障害と対処方針が必須（MR-08: 掘ることにリスクなし） |
