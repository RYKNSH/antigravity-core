---
description: 全ワークフローの入力・出力・完了条件・エラー回復を定義するデータ契約集。
---

# WORKFLOW CONTRACTS

> [!IMPORTANT]
> このファイルはAIエージェントが各ワークフローの**入出力・完了判定・エラー回復**を確認するための契約書。
> WORKFLOW_ROUTER.md とセットで使用する。

---

## 契約フォーマット

各WFは以下の4項目で定義:
- **入力**: 呼出時に必要なデータ
- **出力**: 完了時に生成されるデータ
- **完了条件**: 何をもって「完了」とするか
- **エラー時**: 失敗時のリトライ・フォールバック・エスカレーション

---

## メタワークフロー層

### `/go`
| 項目 | 定義 |
|------|------|
| **入力** | `[タスク文字列]` (任意), `--vision [ビジョン文字列]` (任意) |
| **出力** | セッション完了レポート（checkout出力を継承） |
| **完了条件** | `/checkout` が正常完了 |
| **エラー時** | 各Phase独立。checkin失敗→再実行。work失敗→ユーザーに報告。checkout失敗→最低限git save |

### `/work`
| 項目 | 定義 |
|------|------|
| **入力** | タスク文字列（自然言語） |
| **出力** | 選択されたWFの出力を継承 |
| **完了条件** | 子WF + `/verify` が完了 |
| **エラー時** | WF判定失敗→ユーザーに確認。子WF失敗→子WFのエラー処理に委譲 |

---

## セッションライフサイクル層

### `/checkin`
| 項目 | 定義 |
|------|------|
| **入力** | なし（自動検出） |
| **出力** | 環境ステータスレポート, NEXT_SESSION.md の内容（存在時） |
| **完了条件** | Phase 1-3 全完了, 環境が作業可能状態 |
| **エラー時** | SSD未接続→ローカルのみで続行。npm install失敗→エラー表示して続行 |

### `/checkout`
| 項目 | 定義 |
|------|------|
| **入力** | セッション中の作業コンテキスト（自動収集） |
| **出力** | `NEXT_SESSION.md`, SSDブレインログ, コミット |
| **完了条件** | Phase 0-4 全完了, git変更が保存済み |
| **エラー時** | Score計算失敗→スキップしてログ保存。git失敗→手動コミット提案。SSD未接続→ローカル保存のみ |

---

## ビジョン駆動層

### `/vision-os`
| 項目 | 定義 |
|------|------|
| **入力** | ビジョン文字列（曖昧なリクエスト） |
| **出力** | `VISION.md`, 実装コード, デプロイ可能な成果物 |
| **完了条件** | Phase 5 Quality Gate パス + Phase 6 完了 |
| **エラー時** | debate Block→修正ループ（最大3回）。3回失敗→ユーザーにビジョン再定義を提案 |

### `/evolve-wiz`
| 項目 | 定義 |
|------|------|
| **入力** | 未知技術のキーワード or 実装ファイルパス |
| **出力** | 実装コード, アンチパターンリスト, debate結果 |
| **完了条件** | Phase 4 Review Board パス |
| **エラー時** | Chaos Monkey失敗→アンチパターン記録して続行。debate拒否→修正ループ（最大3回） |

---

## 品質保証層

### `/debate`
| 項目 | 定義 |
|------|------|
| **入力** | 対象ファイル/テキスト, モード(`quick`/`deep`/`team`), preset(任意) |
| **出力** | 議論サマリー, 合否判定(`Pass`/`Block`), 指摘リスト |
| **完了条件** | 全ペルソナの発言完了 + Moderator による統合 |
| **エラー時** | 合意不能→過半数の判定を採用。preset不明→動的チーム編成にフォールバック |

### `/verify`
| 項目 | 定義 |
|------|------|
| **入力** | なし（カレントディレクトリの変更を自動検出）, `--quick`/`--deep` (任意) |
| **出力** | 検証レポート（テスト結果, lint, typecheck, レビュー）, `ship可能` or `要修正` |
| **完了条件** | Phase 1-3 全パス |
| **エラー時** | テスト失敗→失敗箇所を報告、呼出元に戻る。lint失敗→自動修正試行（最大1回） |

### `/fbl`
| 項目 | 定義 |
|------|------|
| **入力** | なし（自動検出）, `quick`/`deep` (任意), verify経由フラグ(内部) |
| **出力** | 検証レポート, 修正リスト, 監査ログ(`fbl_audit.log`) |
| **完了条件** | Phase 7 完了 or Self-Repair ループ上限(3回)到達 |
| **エラー時** | 3回修正失敗→強制停止+ユーザー報告。タイムアウト(30分)→強制停止 |

---

## 開発サイクル層

### `/spec`
| 項目 | 定義 |
|------|------|
| **入力** | 機能名（自然言語） |
| **出力** | `docs/SPEC.md`, debate quick 結果 |
| **完了条件** | SPEC.md生成 + debate quick パス + ユーザー承認 |
| **エラー時** | debate指摘→SPEC.md修正して再debate。ユーザー不承認→インタビューやり直し |

### `/new-feature`
| 項目 | 定義 |
|------|------|
| **入力** | SPEC.md(任意), 機能要件（自然言語可） |
| **出力** | 実装コード, テスト, `docs/DECISIONS.md`, verify結果 |
| **完了条件** | Step 8 品質ゲートパス + Step 11 verify完了 |
| **エラー時** | ユーザー不承認(Step 4)→Step 3に戻る。品質ゲート失敗→Step 6に戻る(最大3回) |

### `/bug-fix`
| 項目 | 定義 |
|------|------|
| **入力** | バグ報告（再現手順 or エラーメッセージ） |
| **出力** | 修正コード, 回帰テスト, 振り返りメモ, verify結果 |
| **完了条件** | バグ再現テストがパス + verify完了 |
| **エラー時** | 再現不能→ユーザーに追加情報要求。根本原因特定不能→バンドエイド+BOTTLENECK.md記録 |

### `/refactor`
| 項目 | 定義 |
|------|------|
| **入力** | 対象コード/モジュール, リファクタリング目的 |
| **出力** | 修正コード, パフォーマンス比較(任意), verify結果 |
| **完了条件** | 全テストパス維持 + verify完了 |
| **エラー時** | テスト失敗→直前のステップにrevert。パフォーマンス劣化→ユーザーに判断委譲 |

---

## インフラ層

### `/ship`
| 項目 | 定義 |
|------|------|
| **入力** | `staging`/`production` (任意, デフォルト: staging) |
| **出力** | デプロイURL, リリースレポート |
| **完了条件** | Phase 4 デプロイ成功 + ヘルスチェック通過 |
| **エラー時** | ビルド失敗→即中止+報告。デプロイ失敗→ロールバック手順提示。**production は常にユーザー確認必須** |

### `/deploy`
| 項目 | 定義 |
|------|------|
| **入力** | ビルド済みアーティファクト |
| **出力** | デプロイURL, ヘルスチェック結果 |
| **完了条件** | ヘルスチェック通過 + エラーログなし |
| **エラー時** | 失敗→ロールバック（`git revert HEAD`）。緊急→Hotfixブランチフロー。**直接呼出しは緊急時のみ、通常は /ship 経由** |

### `/dev`, `/test`, `/build`, `/db-migrate`
| 項目 | 定義 |
|------|------|
| **入力** | なし（プロジェクト設定に依存） |
| **出力** | 実行結果（成功/失敗 + ログ） |
| **完了条件** | コマンド正常終了（exit 0） |
| **エラー時** | /dev: ポート占有→lsof+kill提案。/test: 失敗→失敗テスト一覧。/build: 失敗→エラー箇所特定。/db-migrate: **自動実行禁止、常にユーザー確認** |

---

## ナレッジ層

### `/checkpoint_to_blog`
| 項目 | 定義 |
|------|------|
| **入力** | 作業コンテキスト（自動収集 or ユーザー指定） |
| **出力** | Notion記事（Draft状態）, debate QA結果 |
| **完了条件** | Notionアップロード成功 + debate QA パス |
| **エラー時** | Notion認証失敗→`auth_notion.js`再実行。QA失敗→記事修正ループ(最大2回) |

### `/publish`
| 項目 | 定義 |
|------|------|
| **入力** | Notion上のDraft記事 |
| **出力** | 配信スケジュール, 昇格結果 |
| **完了条件** | Ready状態への昇格 + スケジュール割当 |
| **エラー時** | スクリプト失敗→手動対応案提示 |

### `/learn_from_blog`
| 項目 | 定義 |
|------|------|
| **入力** | Notion記事URL or Page ID |
| **出力** | スキル更新差分, 学習レポート |
| **完了条件** | スキルファイル更新 + ユーザーへ報告 |
| **エラー時** | 記事取得失敗→URL確認要求 |

### `/cleanup-48h`, `/lightweight`
| 項目 | 定義 |
|------|------|
| **入力** | なし |
| **出力** | 削除結果レポート, 空き容量 |
| **完了条件** | 全ステップ実行 + 空き容量表示 |
| **エラー時** | 削除失敗→スキップして次へ。purge失敗→sudo不要でスキップ |

## ブロッカー定義（PAUSE vs 自動続行 vs 自動突破）

> [!IMPORTANT]
> **PAUSE（ユーザー確認待ち）は3条件のみ。それ以外は全て自律的に処理する。**

### PAUSE条件（3つだけ）

| PAUSE条件 | 動作 |
|-----------|------|
| 破壊的操作（deploy production, db-migrate, ファイル削除） | ユーザー確認必須 |
| 設計承認（/new-feature Step 4, /spec Phase 2 ユーザーレビュー） | 設計書提示→承認待ち |
| 情報不足（/spec で回答不能な質問, /bug-fix で再現不能） | ユーザーに質問 |

### 自動突破条件（PAUSEしない → `/debug-deep` で突破）

| 条件 | 動作 |
|------|------|
| エラー上限到達（fbl 3回, debate 3回Block） | → `/debug-deep` 自動発動（First Principles突破） |
| タイムアウト（fbl 30分） | → `/debug-deep` 自動発動（アプローチ転換） |
| `/debug-deep` がさらに3回失敗 | → **真のPAUSE**（エスカレーション） |

### セッション終了の扱い

| 条件 | 動作 |
|------|------|
| `/checkout` 完了 | NEXT_SESSION.md に次タスクを記録 → 次回 `/checkin` で自動再開 |
| Compaction 発生 | `.session_state` から自動復元 |

### 自動続行する場面（PAUSEしない）
- テスト実行・lint・typecheck
- debate（全モード）
- ファイル読み書き
- git add/commit（push以外）
- コード生成・修正
- ワークフロー間遷移
- .session_state の読み書き
- staging デプロイ
- `/debug-deep` の自動発動と実行

---

## セッション内ステート（.session_state）

エージェントはセッション中、以下の状態をプロジェクトルートの `.session_state` ファイルで管理する:

```markdown
# Session State
<!-- AUTO-GENERATED: Do not edit manually -->

## Current
- workflow: /new-feature
- phase: Step 6 (実装)
- started: 2026-02-10T18:50:00+09:00
- parent: /work
- parent_parent: /go

## History
- 18:30 /go started
- 18:31 /checkin completed (OK)
- 18:32 /dev completed (port 5173)
- 18:35 /work started ("ログイン機能のバグ修正")
- 18:35 /work routed to /bug-fix
- 18:40 /bug-fix completed (OK)
- 18:40 /verify --quick started
- 18:42 /verify completed (PASS)
- 18:45 /work started ("ユーザープロフィール機能")
- 18:45 /work routed to /new-feature
- 18:46 /new-feature Phase: Step 6 (実装)

## Pending
- [ ] /new-feature completion → /verify --quick
- [ ] session end → /checkout

## Design Decisions
- Step 3: REST API を選択（GraphQL は過剰。理由: CRUD中心の設計、クライアント1つ）
- Step 5: Prisma ORM を選択（理由: TypeScript型安全性、マイグレーション管理が容易）

## Debug Context (debug-deep 発動時のみ)
- trigger: なし
- error_history: なし
```

### 運用ルール

1. **更新タイミング**: WF開始時・Phase遷移時・WF完了時に更新
2. **読込タイミング**: Compaction後の最初の応答時に `.session_state` を読んでコンテキスト復元
3. **削除タイミング**: `/checkout` 完了時に削除（NEXT_SESSION.md に引き継ぎ）
4. **フォーマット**: Markdown（AIが自然に読み書き可能）
5. **場所**: プロジェクトルート（.gitignore に追加）
