# 消えた一行の行方。


「あれ、さっき直したはずなのに」


画面をリロードした瞬間、修正したはずの誤字が元に戻っている。

狐につままれたような、あの感覚。


開発をしていると、たまにこういう「怪奇現象」に出くわします。

データが消える。

戻る。

なかったことになる。


ぼくが作っている動画編集ソフトでも、先日それが起きました。

テロップのフォントを調整して、プレビューを待つ。

よし、いい感じだと思って保存しても、なぜか古い状態に戻ってしまう。


「保存処理が動いていないのかな」

最初はそう疑いました。

でも、ログを見るとちゃんと「保存しました」と言っているんです。


なのに、データは古いまま。

まるで、誰かが後ろからこっそり書き換えているみたいに。


犯人は、まさしく「後ろ」にいました。

バックグラウンドで動いている、レンダリングワーカーです。


動画を作るには時間がかかるので、裏方のワーカーにお願いするんですが、

このワーカーくん、仕事熱心すぎて「終わったら現状を報告しなきゃ」と、

自分が持っている古いデータを上書きしてしまっていたんです。


ぼくが表でせっせと直している間に、裏で古いデータを「はい、終わりました！」と上書きする。

これじゃあ、いたちごっこです。


「非同期」という言葉があります。

同時にいろんなことが起きる、プログラミングの世界の言葉です。


ぼくらはつい、データを「箱」のようなものだと思ってしまいます。

ここに置いておけば、安全だと。


でも、非同期の世界では、データは箱じゃなくて「川」に近いのかもしれません。

上流から流れてきて、下流で書き換わる。

今見ている水は、もうさっきの水じゃない。


ワーカーが持っているデータは、あくまで「過去のコピー」でした。

それを「正解」として書き戻してしまうと、現在の新しい流れを堰き止めてしまう。


だから、ワーカーから「保存する権限」を取り上げました。

「君は計算だけしてくれればいい。結果の保存は、司令塔であるAPIがやるから」


役割分担を見直したんです。

計算する人と、記録する人を分ける。


そうしたら、怪奇現象はピタリと止まりました。

テロップはもう消えません。


「自分のことは、自分がいちばん見えてない」

プログラムも同じで、自分が最新だと思い込んでいる処理が、実は一番のボトルネックだったりする。


流れを整理するだけで、こんなにも素直になるんですね。

ひとりなのに、ひとりじゃない。

システムの中にも、そんな対話が必要だったのかもしれません。
